<!DOCTYPE html>
<html>

<head>
  <title>Your next ski vacation in State Salzburg, Austria</title>
  <style type='text/css'>
    h2 {
      text-align: center;
    }
    
    h3 {
      text-align: center;
    }
    
    .bullet {
      font: 10px sans-serif;
    }
    
    .bullet .marker {
      stroke: #000;
      stroke-width: 2px;
    }
    
    .bullet .axis line,
    .bullet .axis path {
      stroke: #666;
      stroke-width: .5px;
      fill: none;
    }
    
    .bullet .range.s0 {
      fill: #eee;
    }
    
    .bullet .range.s1 {
      fill: #ccc;
    }
    
    .bullet .range.s2 {
      fill: #aaa;
    }
    
    .bullet .measure.s0 {
      fill: #535353;
    }
    
    .bullet .measure.s1 {
      opacity: 0;
    }
    
    .bullet #tt-bul-title {
      font-size: 14px;
      font-weight: bold;
    }
    
    .bullet #tt-bul-subtitle {
      fill: #ddd;
    }
    
    .bullet .tick {
      fill: #ddd;
    }
  </style>
  <script src='//d3js.org/d3.v3.min.js'></script>
  <script src='//d3js.org/topojson.v1.min.js'></script>
  <script src='colorbrewer.js'></script>
  <script src='bullet.js'></script>
  <script type='text/javascript'>
    //set global variables of width and height as the size of the screen
    var margin = 75,
      width = window.innerWidth - margin,
      height = window.innerHeight - margin,
      svgHeight, svgWidth, svg, featureCollection, path, centered, h2, h3,
      color, gridSize, legendWidth, onClick = 0,
      spPrice1 = {},
      spPrice5 = {},
      dataset = [],
      pie, chart;

    var mouseoverId, mouseoverIdColor;

    var ttState = 0;
    var zoomState = 0, zoomClicked = 0, zoomTransform;
    var mouseoverEvent = 0;
    var outcomeState = 0;
    var outcomeClicked = 1;
    var skiAreas = [],
      skiAreasList = [
        [50618, 50619, 50609, 50625, 50611],
        [50628, 50606, 50602, 50604, 50615, 50616],
        [70912, 70913, 70940, 50607, 50626],
        [50614, 50601],
        [50605, 50613, 50621],
        [50624],
        [50617, 50608, 50622],
        [50610, 50620, 50623, 50627],
        [50415, 50603, 50612],
        [50411, 50413],
        [50402, 50403, 50405],
        [50408, 50423, 50414, 50418, 50417, 50401, 50406, 50407],
        [50425, 50416, 50424],
        [50409],
        [50422, 50512],
        [50504, 50509, 50508, 50503, 50510, 50501, 50502, 50505, 50506, 50507, 50511,
          50514, 50515, 50513],
        [50203, 50210, 50201],
        [50206, 50318]
      ];

    function draw(geoData) {
      //add header and svg, call function drawIntro with callback drawNext
      //set the header of the page
      h2 = d3.select('body')
        .append('h2')
        .text('Your next ski vacation in State Salzburg, Austria');
      h3 = d3.select('body')
        .append('h3')
        .text('Austria is a federal republic made up of 9 states');
      var h2Height = h2.node().getBoundingClientRect().height,
        h3Height = h3.node().getBoundingClientRect().height;
      //add svg on the page with the size of the screen's size
      svgHeight = height - h2Height - h3Height;
      svgWidth = (width + margin * 0.8);
      svg = d3.select('body')
        .append('svg')
        .attr('width', svgWidth)
        .attr('height', svgHeight)
        .attr('xmlns', 'http://www.w3.org/2000/svg')
        .attr('xmlns:xlink', 'http://www.w3.org/1999/xlink');
      drawIntro(geoData);
    };

    function drawIntro(geoData) {
      subHeader('Austria is a federal republic made up of 9 states');
      //draw the map of Austria
      drawMap(geoData);
      //
      //create an array of the states to use during country presentation        
      var states = [];
      featureCollection = topojson.feature(geoData, geoData.objects[Object.keys(
        geoData.objects)[0]]);
      var arrayLength = featureCollection.features.length;
      for (var i = 0; i < arrayLength; i++) {
        states.push(featureCollection.features[i].properties.name);
      };
      //animated highlighting of the states
      var statesIndex = 0;
      var statesInterval = setInterval(function(d) {
        updateStates(statesIndex, states[statesIndex]);
        statesIndex++;
        if (statesIndex > states.length + 3) {
          clearInterval(statesInterval);
        }
      }, 1000);
    };

    function drawOutcomes() {
      var boxBlockHeight = 50; //height of the box
      var boxBlockWidth = 275; //width of the box
      var boxMargin = 15; //distance from svg boarder to box
      var outc = d3.select('svg')
        .append('g')
        .attr('class', 'outcomes')
        .attr('transform', 'translate(15,15)');
   
      function drawBox() {       
        //draw a box above the ski map to avoid interaction before the end of outcomes
        var skiBounds = d3.select('#ski').node().getBBox();
        outc.append('rect')
          .attr('class', 'outcomes')
          .attr('id', 'invision')
          .attr('x', skiBounds['x'])
          .attr('y', skiBounds['y'])
          .attr('height', skiBounds['height'])
          .attr('width', skiBounds['width'])
          .attr('transform','translate(-15,-15)'+d3.select('.map#ski').attr('transform'))
          .attr('opacity',0);
        //draw outcomes box
        outc.append('rect')
          .attr('id', 'outc-rect')
          .attr('rx', 12)
          .attr('ry', 12)
          .attr('width', boxBlockWidth)
          .attr('height', boxBlockHeight * 8)
          .attr('opacity', 0.8)
          .style('fill', '#535353');    

        outc.selectAll('g')
          .data([0,1,2,3,4])
          .enter().append('g')
          .attr('id', function (d) {
            return 'box-block-' + d; 
          });

        outc.select('#box-block-0')
          .append('text')
          .attr('transform', 'translate(' + (boxBlockWidth /2) + ',' + (boxBlockHeight / 2) + ')')
          .style('alignment-baseline', 'middle')
          .style('text-anchor', 'middle')
          .style('fill', '#fff')
          .style('font-weight', 'bold')
          .style('font-size', '1.1em');      

        outc.select('#box-block-1')
          .attr('transform', 'translate (0,' + 0.6 * boxBlockHeight + ')')
          .append("text")
          .attr('transform','translate(' + boxMargin + ', 0)')
          .style('fill', '#fff')
          .style('alignment-baseline', 'middle');  

        outc.select('#box-block-2')
          .attr('transform', 'translate (0,' + 3 * boxBlockHeight + ')')
          .append("text")
          .attr('transform','translate(' + boxMargin + ', 0)')
          .style('fill', '#fff')
          .style('alignment-baseline', 'middle');  

        d3.select('#box-block-3').selectAll('text')
          .data([1,2,3,4])
          .enter().append('text')
          .attr('id', function (d) {return d;})
          .text(function (d) {return d;})
          .attr('transform', function (d,i) {
            if (d === 4) {
              return 'translate(' + (boxBlockWidth/2 + boxBlockWidth/12) + ',' + 6.9 * boxBlockHeight + ')'; 
            } else {
              return 'translate(' + (boxBlockWidth/2 + i * boxBlockWidth/12) + ',' + 6.5 * boxBlockHeight + ')';
            }})
          .style('fill', d3.rgb('#fff').darker(1))
          .style('alignment-baseline', 'middle')
          .on('mouseover', function (d) {
            d3.select(this).style('cursor', 'pointer')
          })
          .on('mouseout', function (d) {
            d3.select(this).style('cursor', 'default')
          });


        d3.select('#box-block-3')
          .append('text')
          .attr('transform', 'translate(' + boxBlockWidth/4 + ',' + 6.5 * boxBlockHeight + ')')
          .text('TOP 3:')
          .style('fill', '#fff')
          .style('alignment-baseline', 'middle');

        d3.select('#box-block-3')
          .append('text')
          .attr('transform', 'translate(' + 0.29*boxBlockWidth + ',' + 6.9 * boxBlockHeight + ')')
          .text('Interesting:')
          .style('fill', '#fff')
          .style('text-anchor','middle')
          .style('alignment-baseline', 'middle');


        d3.select('#box-block-4')
          .append('text')
          .attr('transform', 'translate(' + boxBlockWidth/2 + ',' + 7.5 * boxBlockHeight + ')')
          .text('Try it')
          .style('fill', '#fff')
          .style('alignment-baseline', 'middle')
          .style('text-anchor', 'middle')
          .style('font-weight', 'bold')
          .on('mouseover', function (d) {
            d3.select(this).style('cursor', 'pointer')
          })
          .on('mouseout', function (d) {
            d3.select(this).style('cursor', 'default')
          });

      };

      function addBoxTitle (text) {
        outc.select('#box-block-0 text')
          .text(text);
      };
      
      function addOutcomeText(text,num) {
        
        function wrap(text, width) {
        //function wrap inspired by M. Bostock https://bl.ocks.org/mbostock/7555321
          var words = text.data()[0].split(/\s+/).reverse(),
            word,
            line = [],
            lineNumber = 0,
            lineHeight = 1.1, // ems
            y = 0;
            dy = 1.5;
            tspan = text.text(null).append('tspan').attr('x', 0).attr('y', y).attr('dy', dy + 'em');
          while (word = words.pop()) {
            line.push(word);
            tspan.text(line.join(' '));
            if (tspan.node().getComputedTextLength() > width) {
              line.pop();
              tspan.text(line.join(' '));
              line = [word];
              tspan = text.append('tspan').attr('x', 0).attr('y', y).attr('dy', ++lineNumber * lineHeight + dy + 'em').text(word);
            }
          }
        };

        outc.select('#box-block-'+num+' text')
          .data([text])
          .call(wrap, (boxBlockWidth - 2 * boxMargin));
      };
      
      // init outcome box
      drawBox();
      //outcome 1
      addBoxTitle('Outcomes');
      var outcome1 = '1. TOP 3 most popular ski areas based on nights spent statistics are ' + skiAreas[11].Area + ', ' + skiAreas[0].Area + ' and ' + skiAreas[1].Area + '. The probable reason is total slope length';
      addOutcomeText(outcome1,1); 
      var outcome2 = '2. # of ski lifts to # of nights toursists spent has the largest correlation among all available data. # of nights spent per 1 ski lift ratio might be an interesting normalized metric of ski area popularity. ' + skiAreas[14].Area + ' is a leader probably because of greate variety of choices.';
      addOutcomeText(outcome2,2);


      d3.select('#box-block-3').select('text[id="1"]').style('fill','#fff');
      
      mouseoverId = '11';
      var currentArea = d3.select('#ski').select('g[id="11"]');
      mouseoverIdColor = currentArea.style('fill');  
      currentArea.select('path').style('stroke-width', 3.5);
      currentArea.style('fill', d3.rgb(currentArea.style('fill')).darker(1));
      d3.select('#ski').select('g[id="11"]').each(function(d, i) {
        var onClickFunc = d3.select(this).on("click");
        onClickFunc.apply(this, [d, i]);
      });   
      d3.select('#box-block-3').selectAll('text')
        .on('click', function () {
          if (outcomeClicked != d3.select(this).attr('id')) {
            d3.select('#box-block-3').select('text[id="'+outcomeClicked+'"]')
              .style('fill',d3.rgb('#fff').darker(1));
            outcomeClicked = d3.select(this).attr('id');
            d3.select('#box-block-3').select('text[id="'+outcomeClicked+'"]')
              .style('fill','#fff');
            var outc1Areas = [11,0,1,14];
            var currentArea = d3.select('#ski')
              .select('g[id="' + outc1Areas[d3.select(this).attr('id') - 1] + '"]');            
            currentArea.each(function(d, i) {
              var onClickFunc = d3.select(this).on("click");
              onClickFunc.apply(this, [d, i]);
            });
          }        
        });
      //click event on "try it" button to get to exploration
      d3.select('#box-block-4').select('text')
        .on('click', function () {
          d3.selectAll('.outcomes')
            .transition()
            .duration(500)
            .remove();
          drawTooltip();
          //change the stroke-width of clicked ski area
          d3.select('g[id="' + mouseoverId + '"]')
            .select('path')
            .style('stroke-width', 1.5);
          //change the color of clicked ski area
          d3.select('g[id="' + mouseoverId + '"]').style('fill',
            mouseoverIdColor);
          onClick = 0;
          outcomeState = 1;
          zoom();
        });
      

    };

    function drawNext() {
      //load a map of the State Salzburg
      d3.json('sal_topo.json', function(error, gem) {
        if (error) throw error;
        //draw map of the State Salzburg on top of the map of Austria
        drawMap(gem, 5000, svgWidth / 2 - 27, svgHeight / 2 + 27, '#ddd',
          1);
        d3.select('#id-gemeinden').selectAll('path')
          .style('stroke-width',0.1);
        //this is a rectangle the same size as svg, which is used for click event out of ski area
        svg.append('rect')
          .attr('id', 'background')
          .attr('width', svgWidth)
          .attr('height', svgHeight)
          .style('opacity', 0);

        //adding svg elements for the ski areas visualization             
        d3.select('svg')
          .append('g')
          .attr('class','map')
          .attr('id', 'ski')
          .attr('transform', d3.select('g').attr('transform'));
        //drawing ski areas on the map of Salzburg
        //each ski area is a merge of one or many map counties
        //next selection load information about ski areas and function addSki match it with the 
        //list of counties id
        svg.select('#ski').selectAll('g')
          .data(skiAreasList)
          .enter()
          .append('g')
          .attr('class', 'ski-area')
          .attr('id', function(d, i) {
            return i;
          })
          .each(addSki);

        function addSki(d) {
          d3.select(this).append('path')
            .datum(topojson.merge(gem, gem.objects.gemeinden.geometries.filter(
              function(D) {
                return d3.set(d).has(D.properties['iso']);
              })))
            .attr('class', 'gemeinden-selected')
            .attr('d', path)
            .style('stroke', '#fff')
            .style('stroke-width', 1);
        }
        drawSki();
        //draw the tooltip on the map
        drawTooltip();


      });
    };

    function zoom() {
      if (zoomState === 0) {
        var zoomV = d3.select('svg')
          .append('g')
          .attr('class', 'zoom')
          .attr('transform', 'translate(15,15)')
          .selectAll('g')
          .data([0,1])
          .enter().append('g')
          .attr('id', function(d) {
            if (d===0) {
              return 'plus';
            } else {return 'minus';}})
          .attr('transform',function (d) {
            return 'translate(' + 0 + ',' + d*25 + ')';});

          zoomV.append('rect')
            .transition()
            .duration(500)
            .attr('rx', 5)
            .attr('ry', 5)
            .attr('width', 25)
            .attr('height', 25)
            .style('fill', '#ddd')
          
          zoomV.append('text')
            .attr('transform', 'translate(12.5,12.5)')
            .style('text-anchor','middle')
            .style('alignment-baseline','middle')
            .style('font-size',25)
            .style('fill', '#aaa')
            .text(function(d) {
              if (d===0) {
                return '+';
              } else {return '-';}})
            .on('mouseover', function(d) {
              d3.select(this).style('cursor', 'pointer')
            })
            .on('mouseout', function(d) {
              d3.select(this).style('cursor', 'default')
            });

          d3.select('.zoom').select('#minus')
            .on('mouseover', function(d) {debugger;
              d3.select(this).style('cursor', 'pointer')
            })
            .on('mouseout', function(d) {
              d3.select(this).style('cursor', 'default')
            })
            .on('click', function () {debugger;
              if (zoomClicked === 0) {
                zoomClicked = 1;
                zoomTransform = d3.selectAll('.map').attr('transform');
                d3.select('.zoom').select('#minus').select('text').style('fill', '#aaa');
                d3.select('.zoom').select('#plus').select('text').style('fill', '#646464');
                d3.select('svg')
                  .selectAll('.map')
                  .transition()
                  .duration(500)
                  .attr('transform','scale(1,1)');
                } 
            });
          d3.select('.zoom').select('#plus')
            .on('click', function () {
              if (zoomClicked === 1) {
                zoomClicked = 0;
                d3.select('.zoom').select('#plus').select('text').style('fill', '#aaa');
                d3.select('.zoom').select('#minus').select('text').style('fill', '#646464');
                d3.selectAll('.map')
                  .transition()
                  .duration(500)
                  .attr('transform', zoomTransform);
              }
            }); 
          d3.select('.zoom').select('#minus').select('text').style('fill', '#646464');
          
      };
    };

    function subHeader(text) {
      d3.select('h3')
        .text(text);
    };

    function updateStates(statesIndex, state) {
      if (statesIndex === 9) {
        //step# 1 after states introduction
        subHeader('And State Salzburg is in the middle of it')
        d3.select('text').remove();
        svg.selectAll('path')
          .style('fill', '#aaa')
          .style('stroke-width', 1.5);
        d3.select('[location=Salzburg]').style('fill', '#ddd');
        //zoon in State Salzburg
        var centroid = path.centroid(featureCollection.features[3]);
        d3.selectAll('g')
          .transition()
          .duration(750)
          .attr('transform', 'translate(' + svgWidth / 2 + ',' + svgHeight /
            2 + ')scale(' + 3 + ')translate(' + -centroid[0] + ',' + -0.95 *
            centroid[1] + ')')
          .style('stroke-width', 0.5 + 'px');
        //zoon in State Salzburg end
      } else if (statesIndex === 10) {} else if (statesIndex === 11) {
        //step# 2 after states introduction
        subHeader(
          'There are 18 skiing areas in State Salzburg. Choose the one you visit next'
        );
        drawNext();
      } else if (statesIndex === 12) {
        drawOutcomes();
      } else {
        d3.select('text').remove();
        svg.selectAll('path')
          .style('fill', '#aaa')
          .style('stroke-width', 1.5);
        svg.select('[location=' + state + ']')
          .transition()
          .duration(500)
          .style('fill', 'orange')
          .style('stroke-width', 5.5);
        var centroidX = path.centroid(featureCollection.features[statesIndex])[
            0],
          centroidY = path.centroid(featureCollection.features[statesIndex])[1];
        d3.select('svg')
          .append('text')
          .text(state);
        var stateHeight = d3.select('text').node().getBoundingClientRect().height,
          stateWidth = d3.select('text').node().getBoundingClientRect().width;
        d3.select('text').remove();
        d3.select('svg')
          .append('text')
          .text(state)
          .attr('x', centroidX - stateWidth / 2)
          .attr('y', centroidY + stateHeight / 2)
          .style('color', 'white');
      };
    };

    function drawMap(geoData, scale = 5000, x = svgWidth / 2, y = svgHeight /
      2, color = '#aaa', strW = 1.5) {
      //check the bounds of the map to identify projection center correctly
      var loc = Object.keys(geoData.objects)[0];
      featureCollection = topojson.feature(geoData, geoData.objects[Object.keys(
        geoData.objects)[0]]);
      var bounds = d3.geo.bounds(featureCollection);

      // identify coordinates to set as the center of projection
      var centerX = d3.sum(bounds, function(d) {
          return d[0];
        }) / 2,
        centerY = d3.sum(bounds, function(d) {
          return d[1];
        }) / 2;
      // set projection mercator with scale, center coordinates and translate to the middle of the screen
      var projection = d3.geo.mercator()
        .scale(scale)
        .center([centerX, centerY])
        .translate([x, y]);

      path = d3.geo.path()
        .projection(projection);

      //visualize map
      var map = d3.select('svg')
        .append('g')
        .attr('class', 'map')
        .attr('id', 'id-' + loc)
        .attr('transform', d3.select('g').attr('transform'))
        .selectAll('path')
        .data(featureCollection.features)
        .enter()
        .append('path')
        .attr('location', function(d) {
          return d.properties.name;
        })
        .attr('id', loc)
        .attr('iso', function(d) {
          return d.properties.iso;
        })
        .attr('d', path)
        .style('fill', color)
        .style('stroke', '#fff')
        .style('stroke-width', strW);
    };

    function drawTooltip() {
      //draws tooltip's box
      var ttBlockHeight = 50; //height of the tooltip's block
      var ttBlockWidth = 275; //width of the tooltip's block
      var ttMargin = 15; //distance from svg boarder to tooltip

      function helper () {
        var helperWidth = ttBlockWidth * 0.8;
        var helperHeigh = 100;

        var helperSect = d3.select('#tooltip')  
          .append('g')
          .attr('class', 'helper')
          .attr('transform', function (d,i) {
              return 'translate(' + ttBlockWidth*0.1 + ',' + 1.8*ttBlockHeight +')'});
        
        helperSect.append('rect')
          .attr('rx', 12)
          .attr('ry', 12)
          .attr('width', helperWidth)
          .attr('height', helperHeigh)
          .style('fill', '#ddd');

        helperSect.append('text')
          .attr('transform','translate('+helperWidth/2+','+ttMargin+')')
          .text('# of nights tourists spent')
          .style('text-anchor','middle')
          .style('fill','#535353')
          .style('font-weight', 'bold');

        helperSect.append('text')
          .attr('transform','translate('+ttMargin+','+2*ttMargin+')')
          .append('tspan')
          .attr('x', 0)
          .attr('dy', 5)
          .text('Number of nights tourists spent')
          .style('font-size','14px')
          .style('fill','#646464')
          .append('tspan')
          .attr('x', 0)
          .attr('dy', 20)
          .text('in the area during the winter')
          .style('fill','#646464')
          .append('tspan')
          .attr('x', 0)
          .attr('dy', 20)
          .text('season 2015 / 2016 according to')
          .style('fill','#646464')
          .append('tspan')
          .attr('x', 0)
          .attr('dy', 20)
          .text('www.statistik.at')
          .style('fill','#646464');
        
      };

      function drawLegend (d) {      
        var legendText = ['150k', '500k', '1500k', ''];

        var legendC = d.selectAll('.legend')
          .data(colorbrewer.YlOrBr[4])
          .enter()
          .append('g')
          .attr('class', 'legend');

        legendC.append('rect')
          .attr('transform', function (d,i) {
            return 'translate(' + (ttBlockWidth/10 + i * ttBlockWidth/5) + ',' + ttBlockHeight/6 +')'})
          .attr('width', ttBlockWidth / 5)
          .attr('height', ttBlockHeight / 3)
          .style('fill', function (d) {return d;})
          .attr('class', 'square');
        
        d.append('text')
            .attr('class', 'legend')
            .attr('id', 'legend-title')
            .attr('transform', 'translate(' + (ttBlockWidth/2) + ',' + 0 + ')')
            .text('# of nights tourists spent')
            .style('fill', '#fff')
            .style('alignment-baseline', 'middle')
            .style('text-anchor', 'middle');
        
        legendC.append('text')
          .attr('class', 'legend')
          .attr('id', 'legend-info')
          .text(function(d, i) {
            return legendText[i];
          })
          .attr('transform', function (d,i) {
            return 'translate(' + (ttBlockWidth/10 + (i+1) * ttBlockWidth/5) + ',' + ttBlockHeight*0.7 +')'})
          .style('text-anchor', 'middle')
          .style('fill', '#ddd')
          .style('font-size', '10px');

        d.append('image')
          .attr('class', 'legend')
          .attr('id', 'legend-info')
          .attr('xlink:href', 'info-2-16.ico')
          .attr('transform', 'translate(' + (ttBlockWidth*0.9 - 25) + ',' + (-8) + ')')
          .attr('height', '12')
          .attr('width', '12')
          .on('mouseover', helper)
          .on('mouseout', function () {d3.selectAll('.helper').remove();});
      };

      function drawTTData() {
        //function drawTTData draws visualization elements in the toolbox
        
        function drawArc () {
          //draw arc
          function helper () {
            var helperWidth = ttBlockWidth * 0.45;
            var helperHeigh = ttBlockWidth * 0.45;

            var helperSect = d3.select('#tooltip')  
              .append('g')
              .attr('class', 'helper')
              .attr('transform', function (d,i) {
                  return 'translate(' + ttBlockWidth*0.5 + ',' + 2.7*ttBlockHeight +')'});
            
            helperSect.append('rect')
              .attr('rx', 12)
              .attr('ry', 12)
              .attr('width', helperWidth)
              .attr('height', helperHeigh)
              .style('fill', '#ddd');

            var legendText = ['Easy', 'Medium', 'Hard'];
            var color = ['#32598d', '#c0241f', '#060606'];
            
            var legendC = helperSect.selectAll('.legend')
              .data(color)
              .enter()
              .append('g')
              .attr('class', 'legend');

            legendC.append('rect')
              .attr('transform', function (d,i) {
                return 'translate(' + 15 + ',' + (0.25*helperHeigh + i * 0.15*helperHeigh) +')'})
              .attr('width', 0.1*helperHeigh)
              .attr('height', 0.1*helperHeigh)
              .style('fill', function (d) {return d;})
              .attr('class', 'square');

            legendC.append('text')
              .attr('class', 'legend')
              .attr('id', 'legend-info')
              .text(function(d, i) {
                return legendText[i];
              })
              .attr('transform', function (d,i) {
                return 'translate(' + (30 + 0.1 * helperHeigh) + ',' + (0.31*helperHeigh + i * 0.15*helperHeigh) +')'})
              .style('alignment-baseline','middle')
              .style('fill', '#ddd')
              .style('fill','#646464')
              .style('font-size','14px');
            
            helperSect.append('text')
              .attr('class', 'legend')
              .attr('id', 'legend-title')
              .attr('transform', 'translate(' + helperWidth/2 + ',' + 15 + ')')
              .text('Slopes')
              .style('fill', '#fff')
              .style('alignment-baseline', 'middle')
              .style('text-anchor', 'middle')
              .style('fill','#535353')
              .style('font-weight', 'bold');
            
            helperSect.append('text')
              .attr('class', 'legend')
              .attr('id', 'legend-title')
              .attr('transform', 'translate(' + helperWidth/2 + ',' + 15 + ')')
              .text('Slopes')
              .style('fill', '#fff')
              .style('alignment-baseline', 'middle')
              .style('text-anchor', 'middle')
              .style('fill','#535353')
              .style('font-weight', 'bold');

            var ttArcKmVar = 0;
            ttArcKmVar += Number(skiAreas[mouseoverId].DiffKM);
            ttArcKmVar += Number(skiAreas[mouseoverId].MedKM);
            ttArcKmVar += Number(skiAreas[mouseoverId].EasyKM);
            
            helperSect.append('text')
              .attr('class', 'legend')
              .attr('transform', 'translate(' + (15 + 0.05 * helperHeigh) + ',' + 0.77 * helperHeigh + ')')
              .style('alignment-baseline', 'midle')
              .style('fill','#646464')
              .style('font-size','14px')
              .style('font-weight', 'bold')
              .style('text-anchor', 'middle')
              .append('tspan')
              .attr('x', 0)
              .attr('dy', 5)
              .text(ttArcKmVar)// + ' km')
              .append('tspan')
              .attr('x', 0)
              .attr('dy', 14)
              .text('km');
              
            helperSect.append('text')
              .attr('transform','translate('+ (30 + 0.1 * helperHeigh) +','+ 0.77 * helperHeigh + ')')
              .append('tspan')
              .attr('x', 0)
              .attr('dy', 5)
              .text('Length of')
              .style('font-size','14px')
              .style('fill','#646464')
              .append('tspan')
              .attr('x', 0)
              .attr('dy', 14)
              .text('all slopes')
              .style('fill','#646464');
          };

          var dataset = [{
            label: 'Black',
            count: skiAreas[mouseoverId].DiffKM
          }, {
            label: 'Red',
            count: skiAreas[mouseoverId].MedKM
          }, {
            label: 'Blue',
            count: skiAreas[mouseoverId].EasyKM
          }];
          var width = 100;
          var height = 100;
          var radius = Math.min(width, height) / 2;
          var donutWidth = 20;
          //arc visualize the length of black(difficult), red(middle), blue(easy) slopes
          //create color scale
          var color = d3.scale.ordinal()
            .domain(['Red', 'Black', 'Blue'])
            .range(['#c0241f', '#060606', '#32598d']);
          //made arc global variable to update the arc  
          arc = d3.svg.arc()
            .innerRadius(radius - donutWidth)
            .outerRadius(radius);
          //made pie global variable to update the arc  
          pie = d3.layout.pie()
            .value(function(d) {
              return d.count;
            })
            .sort(null);

          d3.select('#tt-block-3').append('text')
            .attr('class', 'tt-data')
            .attr('id', 'tt-arc-title')
            .text('Slopes')
            .attr('transform', 'translate(' + ttBlockWidth/4 + ',' + ttBlockHeight/2 + ')')
            .style('text-anchor', 'middle')
            .style('alignment-baseline', 'middle')
            .style('fill', '#fff');

          var path = d3.select('#tt-block-3').selectAll('path')
            .data(pie(dataset))
            .enter()
            .append('path')
            .attr('class', 'tt-data')
            .attr('id', 'tt-arc-path')
            .attr('d', arc)
            .attr('fill', function(d, i) {
              return color(d.data.label);
            })
            .attr('transform', 'translate(' + ttBlockWidth/4 + ',' + 1.8 * ttBlockHeight + ')')
            .each(function(d) {
              this._current = d;
            });
            var ttArcKmVar = 0;
            for (var i = 0; i < 3; i++) {
              ttArcKmVar += Number(dataset[i].count);
            }
            d3.select('#tt-block-3').append('text')
              .attr('class', 'tt-data')
              .attr('id', 'tt-arc-km')
              .text(ttArcKmVar + ' km')
              .attr('transform', 'translate(' + ttBlockWidth/4 + ',' + 1.9 * ttBlockHeight + ')')
              .style('text-anchor', 'middle')
              .style('alignment-baseline', 'midle')
              .attr('fill', '#fff');   

            d3.select('#tt-block-3').append('image')
              .attr('class', 'tt-data')
              .attr('id', 'tt-arc-info')
              .attr('xlink:href', 'info-2-16.ico')
              .attr('transform', 'translate(' + (ttBlockWidth/4 + 25) + ',' + (ttBlockHeight/2 - 7) + ')')
              .attr('height', '12')
              .attr('width', '12')
              .on('mouseover', helper)
              .on('mouseout', function () {d3.selectAll('.helper').remove();});     
        };
        
        function drawLifts() {
          //draw lift information
          d3.select('#tt-block-3').append('text')
            .attr('class', 'tt-data')
            .attr('id', 'tt-lift-title')
            .text('Ski lifts')
            .attr('transform', 'translate(' + 0.75 * ttBlockWidth + ',' + ttBlockHeight/2 + ')')
            .style('text-anchor', 'middle')
            .style('alignment-baseline', 'middle')
            .style('fill', '#fff');
          d3.select('#tt-block-3')
            .append('image')
            .attr('class', 'tt-data')
            .attr('id', 'tt-lift-icon')
            .attr('xlink:href', 'ski_lift_icon.svg')
            .attr('transform', 'translate(' + (0.75 * ttBlockWidth - 50) + ',' + 0.75 * ttBlockHeight + ')')
            .attr('height', '100')
            .attr('width', '100');
          d3.select('#tt-block-3').append('text')
            .attr('class', 'tt-data')
            .attr('id', 'tt-lift-n')
            .text(skiAreas[mouseoverId].Lifts)
            .attr('transform', 'translate(' + 0.75 * ttBlockWidth + ',' + 2.5 * ttBlockHeight + ')')
            .style('text-anchor', 'middle')
            .style('alignment-baseline', 'middle')
            .attr('fill', '#fff');
        };

        function drawBullets() {
          //draw price bullets
          function helper () {
            var helperWidth = ttBlockWidth * 0.85;
            var helperHeigh = 140;

            var helperSect = d3.select('#tooltip')  
              .append('g')
              .attr('class', 'helper')
              .attr('transform', function (d,i) {
                  return 'translate(' + ttBlockWidth*0.075 + ',' + 2.45 * ttBlockHeight +')'});
            
            helperSect.append('rect')
              .attr('rx', 12)
              .attr('ry', 12)
              .attr('width', helperWidth)
              .attr('height', helperHeigh)
              .style('fill', '#ddd');

            helperSect.append('text')
              .attr('transform','translate('+helperWidth/2+','+ttMargin+')')
              .text('Ski pass prices')
              .style('text-anchor','middle')
              .style('fill','#535353')
              .style('font-weight', 'bold');

            helperSect.append('text')
              .attr('transform','translate('+ttMargin+','+2*ttMargin+')')
              .append('tspan')
              .attr('x', 0)
              .attr('dy', 5)
              .text('Bullet charts visualize statistics')
              .style('font-size','14px')
              .style('fill','#646464')
              .append('tspan')
              .attr('x', 0)
              .attr('dy', 20)
              .text('for ski pass prices.')
              .style('fill','#646464');

             helperSect.append('image') 
              .attr('xlink:href', 'bullet.png')
              .attr('transform', 'translate(' + (-5) + ',' + 0.65 * helperHeigh + ')')
              .attr('height', '15')
              .attr('width', helperWidth)

            helperSect.append('text')
              .attr('transform', 'translate(' + (2.3*ttMargin + 112) + ',' + 66 + ')')
              .attr('class', 'legend')
              .style('alignment-baseline', 'midle')
              .style('fill','#646464')
              .style('font-size','10px')
              .style('font-weight', 'bold')
              .append('tspan')
              .attr('x', 0)
              .attr('dy', 5)
              .text('Avg price')
              .append('tspan')
              .attr('x', 0)
              .attr('dy', 10)
              .text('among all');
             helperSect.append('text')
              .attr('transform', 'translate(' + (2.3*ttMargin + 60) + ',' + 115 + ')')
              .attr('class', 'legend')
              .style('alignment-baseline', 'midle')
              .style('fill','#646464')
              .style('font-size','10px')
              .style('font-weight', 'bold')
              .append('tspan')
              .attr('x', 0)
              .attr('dy', 5)
              .text('Min price')
              .append('tspan')
              .attr('x', 0)
              .attr('dy', 10)
              .text('among all'); 
            helperSect.append('text')
              .attr('transform', 'translate(' + (2.3*ttMargin + 112) + ',' + 115 + ')')
              .attr('class', 'legend')
              .style('alignment-baseline', 'midle')
              .style('fill','#646464')
              .style('font-size','10px')
              .style('font-weight', 'bold')
              .append('tspan')
              .attr('x', 0)
              .attr('dy', 5)
              .text('Max price')
              .append('tspan')
              .attr('x', 0)
              .attr('dy', 10)
              .text('among all'); 

            helperSect.append('line')
              .attr('x1', 136)
              .attr('y1', 107)
              .attr('x2', 136)
              .attr('y2', 114)
              .style('stroke','#646464');

            helperSect.append('line')
              .attr('x1', 189)
              .attr('y1', 107)
              .attr('x2', 189)
              .attr('y2', 114)
              .style('stroke','#646464');

            helperSect.append('line')
              .attr('x1', 169)
              .attr('y1', 85)
              .attr('x2', 169)
              .attr('y2', 92)
              .style('stroke','#646464');
          };

          d3.select('#tt-block-3').append('text')
            .attr('class', 'tt-data')
            .attr('id', 'tt-price-title')
            .text('Ski pass prices')
            .attr('transform', 'translate(' + ttBlockWidth/2 + ',' + 3.2 * ttBlockHeight + ')')
            .style('text-anchor', 'middle')
            .attr('fill', '#fff');

          d3.select('#tt-block-3').append('image')
            .attr('class', 'tt-data')
            .attr('id', 'tt-price-info')
            .attr('xlink:href', 'info-2-16.ico')
            .attr('transform', 'translate(' + 0.69 * ttBlockWidth + ',' + (3.2 * ttBlockHeight - 10) + ')')
            .attr('height', '12')
            .attr('width', '12')
            .on('mouseover', helper)
            .on('mouseout', function () {d3.selectAll('.helper').remove();});  
          //bullets inspired by M. Bostock
          var margin = {
              top: 5,
              right: 40,
              bottom: 20,
              left: 120
            },
            //width = 180,
            width = 0.6 * ttBlockWidth;
            height = 15;
          chart = d3.bullet()
            .orient('left')
            .width(width)
            .height(height);
          var data = [{
            'title': '1 day',
            'subtitle': 'EUR',
            'ranges': [spPrice1.min, spPrice1.max, spPrice1.max],
            'measures': [skiAreas[mouseoverId].PriceH1, skiAreas[
              mouseoverId].PriceH1],
            'markers': [spPrice1.avg]
          }, {
            'title': '5 day',
            'subtitle': 'EUR',
            'ranges': [spPrice5.min, spPrice5.max, spPrice5.max],
            'measures': [skiAreas[mouseoverId].PriceH5, skiAreas[
              mouseoverId].PriceH5],
            'markers': [spPrice5.avg]
          }]; 
          d3.json('', function(error, data1) {
            var bulletChart = d3.select('#tt-block-3')
              .append('g')
              .attr('class', 'bullet')
              .selectAll('g')
              .data(data)
              .enter().append('g')
              .attr('class', 'bullet')
              .attr('id', 'tt-bul')
              .attr('width', 100)
              .attr('height', height + margin.top + margin.bottom)
              .attr('transform', function(d, i) {
                return 'translate(' + (0.3 * ttBlockWidth) + ',' + (4.2 * ttBlockHeight + (
                  i - 1) * 35) + ')'
              })
              .call(chart);
            var title = bulletChart.append('g')
              .style('text-anchor', 'end')
              .style('alignment-baseline', 'middle')
              .attr('transform', function(d, i) {
                return 'translate(' + (-0.05 * ttBlockWidth) + ',' + 0.5 * height + ')'
              })
              .style('fill', '#fff')
            title.append('text')
              .attr('class', 'tt-data')
              .attr('id', 'tt-bul-title')
              .text(function(d) {
                return d.title;
              });
            title.append('text')
              .attr('class', 'tt-data')
              .attr('id', 'tt-bul-subtitle')
              .attr('dy', '1.2em')
              .text(function(d) {
                return d.subtitle;
              });
          })
        };

        drawArc();
        drawLifts();
        drawBullets();       
      };

      // draw tooltip
      if (ttState === 0) {
        var tt = svg.append('g')
          .attr('id', 'tooltip')
          .attr('transform', 'translate('+(svgWidth - ttBlockWidth - ttMargin) + ',' + ttMargin + ')');

        tt.append('rect')
          .attr('id', 'tt-rect')
          .attr('rx', 12)
          .attr('ry', 12)
          .attr('width', ttBlockWidth)
          .attr('height', ttBlockHeight * 3.6)
          .attr('opacity', 0.8)
          .style('fill', '#535353');
        tt.selectAll('g')
          .data([0,1,2,3])
          .enter().append('g')
          .attr('class','tt-block')
          .attr('id',function (d) {return 'tt-block-' + d;})
          .attr('transform',function (d,i) {
            if (i<2) {
              return 'translate(' + 0 + ',' + (i * ttBlockHeight) + ')';
            } else {
              return 'translate(' + 0 + ',' + (i * ttBlockHeight * 0.8) + ')';}
            });
        tt.select('#tt-block-0')
          .append('text')
          .text('Ski area')
          .attr('transform', 'translate(' + (ttBlockWidth /2) + ',' + (ttBlockHeight / 2) + ')')
          .style('alignment-baseline', 'middle')
          .style('text-anchor', 'middle')
          .style('fill', '#fff')
          .style('font-weight', 'bold')
          .style('font-size', '1.1em');
        tt.select('#tt-block-1')
          .call(drawLegend);
        tt.select('#tt-block-2')
          .append('text')
          .attr('id', 'tt-2')
          .text('Hover over a ski area')
          .attr('transform', 'translate(' + (ttBlockWidth /2) + ',' + 0.6 * ttBlockHeight + ')')
          .style('alignment-baseline', 'middle')
          .style('text-anchor', 'middle')
          .style('fill', d3.rgb('#fff').darker(1));
        
        ttState = 1;
      } else {
        //ttState = 1: tooltip was initialized
        if (onClick === 0) {
          if (mouseoverEvent === 1) {
            d3.select('#tt-block-3')
                .append('text')
                .attr('id','tt-block-3-text')
                .text('Click to get details')
                .attr('transform', 'translate(' + (ttBlockWidth /2) + ',' + 0.6 * ttBlockHeight + ')')
                .style('alignment-baseline', 'middle')
                .style('text-anchor', 'middle')
                .style('fill', d3.rgb('#fff').darker(1));
          } else {
            //click event on ski area
            d3.select('#tt-2')
              .text(skiAreas[mouseoverId].Area)
              .style('fill', 'orange');
            d3.select('#tt-block-3-text').remove(); 
            d3.select('#tt-rect')
              .transition()
              .duration(500)
              .attr('height', ttBlockHeight * 7.5)
              .each('end', drawTTData); //.each works as callback, drawTTData called after transition
            }
        } else {
          d3.select('#tt-rect')
            .transition()
            .duration(500)
            .attr('height', 3.6 * ttBlockHeight);
          //change the text in tooltip
          d3.select('#tt-2')
            .text('Hover over a ski area')
            .style('fill', d3.rgb('#fff').darker(1));
          //remove visualizations from tooltip
          d3.selectAll('.tt-data').remove();
          d3.selectAll('.bullet').remove(); 
        }
      }
    };

    function drawSki() {
      //visualize ski areas and manage explorational events
      d3.tsv('ski_areas.tsv', function(error, skiAreasData) {
        if (error) throw error;
        //extend the array skiAreas with the information about ski areas
        //from the tsv file
        for (var i = 0; i < skiAreasList.length; i++) {
          skiAreas[i] = {};
          skiAreas[i]['loc'] = skiAreasList[i];
          for (key in skiAreasData[i]) {
            skiAreas[i][key] = skiAreasData[i][key];
          }
        }
        //calculating statistics of the ski pass prices
        var spPrice1List = [],
          spPrice5List = [];
        for (i = 0; i < skiAreas.length; i++) {
          spPrice1List.push(skiAreas[i]['PriceH1']);
          spPrice5List.push(skiAreas[i]['PriceH5']);
        }
        spPrice1 = {
          'min': Math.min.apply(null, spPrice1List),
          'avg': Math.round(spPrice1List.reduce(function(a, b) {
            return Number(a) + Number(b);
          }, 0) / spPrice1List.length),
          'max': Math.max.apply(null, spPrice1List)
        }
        spPrice5 = {
            'min': Math.min.apply(null, spPrice5List),
            'avg': Math.round(spPrice5List.reduce(function(a, b) {
              return Number(a) + Number(b);
            }, 0) / spPrice5List.length),
            'max': Math.max.apply(null, spPrice5List)
          }
          //ski areas are filled with the color based on the number
          //of nights tourists spent in the areas during the winter 2015
          //create color scale
        color = d3.scale.threshold()
          .domain([150000, 500000, 1500000])
          .range(colorbrewer.YlOrBr[4]);
        //fill the ski areas with the color based on night spent      
        d3.select('#ski')
          .style('fill', '#ffffe5')
          .transition()
          .duration(1000)
          .selectAll('g')
          .style('fill', function() {
            return color(skiAreas[d3.select(this).attr('id')]['Nights']);
          });
        //on click event handlers
        //click on the background to cancel all highlights
        d3.select('#background')
          .on('click', function() {
            //change the size of the tooltip
            if (onClick !== 0 && outcomeState === 1) {
              resetSki();
            };
          });
        //events on ski areas
        d3.selectAll('.ski-area')
          .on('mouseover', function() {
            if (onClick === 0) {
              mouseoverId = d3.select(this).attr('id');
              mouseoverIdColor = d3.select(this).style('fill');
              d3.select('#tt-2')
                .text(skiAreas[mouseoverId].Area)
                .style('fill', 'orange');
              d3.select(this).select('path').style('stroke-width', 3.5);
              d3.select(this).style('fill', function() {
                return d3.rgb(d3.select(this).style('fill')).darker(1);
              })
              mouseoverEvent = 1;   
              drawTooltip();           
            }
          })
          .on('mouseout', function() {
            mouseoverEvent = 0;
            d3.select('#tt-block-3-text').remove();
            if (onClick === 0) {
              d3.select('#tt-2')
                .text('Hover over a ski area')
                .style('fill', d3.rgb('#fff').darker(1));
              d3.select('g[id="' + mouseoverId + '"]')
                .select("path")
                .style("stroke-width", 1.5);
              d3.select('g[id="' + mouseoverId + '"]').style('fill',
                mouseoverIdColor);
            }
          })
          .on('click', function() {
            mouseoverEvent = 0;
            if (onClick === 0) {
              mouseoverId = d3.select(this).attr('id');
              clickSki();
            } else {
              if (d3.select(this).attr('id') !== mouseoverId) {
                //change the stroke-width of clicked ski area
                d3.select('g[id="' + mouseoverId + '"]')
                  .select('path')
                  .style('stroke-width', 1.5);
                //change the color of clicked ski area
                d3.select('g[id="' + mouseoverId + '"]').style('fill',
                  mouseoverIdColor);
                mouseoverId = d3.select(this).attr('id');
                mouseoverIdColor = d3.select(this).style('fill');
                dataset = [{
                  label: 'Black',
                  count: skiAreas[mouseoverId].DiffKM
                }, {
                  label: 'Red',
                  count: skiAreas[mouseoverId].MedKM
                }, {
                  label: 'Blue',
                  count: skiAreas[mouseoverId].EasyKM
                }];
                d3.select(this).select('path').style('stroke-width', 3.5);
                d3.select(this).style('fill', function() {
                    return d3.rgb(d3.select(this).style('fill')).darker(
                      1);
                  })
                  //click area              
                d3.select('#tt-2')
                  .transition()
                  .duration(500)
                  .text(skiAreas[mouseoverId].Area)
                  .style('fill', 'orange');
                //change # of lifts
                d3.select('#tt-lift-n')
                  .transition()
                  .duration(500)
                  .text(skiAreas[mouseoverId].Lifts);
                //change length of slopes
                var ttArcKmVar = 0;
                for (var i = 0; i < 3; i++) {
                  ttArcKmVar += Number(dataset[i].count)
                };
                d3.select('#tt-arc-km')
                  .transition()
                  .duration(500)
                  .text(ttArcKmVar + ' km');
                //update arc
                d3.select('#tooltip').selectAll('path').data(pie(dataset))
                  .transition().duration(500)
                  .attrTween('d', arcTween);

                function arcTween(a) {
                  var i = d3.interpolate(this._current, a);
                  this._current = i(0);
                  return function(t) {
                    return arc(i(t));
                  };
                }
                //update bullets
                var data = [{
                  'title': '1 day',
                  'subtitle': 'EUR',
                  'ranges': [spPrice1.min, spPrice1.max, spPrice1.max],
                  'measures': [skiAreas[mouseoverId].PriceH1,
                    skiAreas[mouseoverId].PriceH1
                  ],
                  'markers': [spPrice1.avg]
                }, {
                  'title': '5 day',
                  'subtitle': 'EUR',
                  'ranges': [spPrice5.min, spPrice5.max, spPrice5.max],
                  'measures': [skiAreas[mouseoverId].PriceH5,
                    skiAreas[mouseoverId].PriceH5
                  ],
                  'markers': [spPrice5.avg]
                }];
                d3.selectAll('#tt-bul').data(data).call(chart.duration(
                  500));
                //update bullets end
              } else {
                if (outcomeState === 1) {resetSki();}
              }
            }
          });

        function resetSki() {
          //function resetSki removes content of the tooltip box and changes it's height
          drawTooltip();
          //change the stroke-width of clicked ski area
          d3.select('g[id="' + mouseoverId + '"]')
            .select('path')
            .style('stroke-width', 1.5);
          //change the color of clicked ski area
          d3.select('g[id="' + mouseoverId + '"]').style('fill',
            mouseoverIdColor);
          onClick = 0;
        };

        function clickSki() {
          //highlight the clicked area
          drawTooltip();
          onClick = 1;
        };

      })
    };

  </script>
</head>

<body>
  <script type='text/javascript'>
    d3.json('oesterreich.json', function(error, at) {
      if (error) throw error;
      draw(at);
    });
  </script>
</body>

</html>